\newcommand{\Val}{\fun{Val}}
\newcommand{\Utxo}{\fun{Utxo}}

\section{Formal Properties}
\label{sec:properties}

This appendix collects the main formal properties that the new ledger
rules are expected to satisfy. First, we define two functions that are
used for formulating the properties more easily.

\begin{definition}
  For a state $s$ that is used in any subtransaction of
  $\mathsf{CHAIN}$, we define $\Utxo(s) \in \UTxO$ to be the $\UTxO$
  contained in $s$, or an empty map if it does not exist. This is
  similar to the definition of $\Val$ in the Shelley specification.
\end{definition}

We also define a helper function $\varphi$ as follows:
\[\varphi(x, t) :=
  \begin{cases}
    x & \fun{txValTag}~t = \True \\
    0 & \fun{txValTag}~t = \False
  \end{cases}\]
This function is useful to distinguish between the two
cases where a transaction can mint tokens or not, depending on whether
its scripts validate.

First, we state the Alonzo version of the preservation of value theorem.

\begin{lemma}
  For all environments $e$, transactions $t$ and states $s, s'$, if
  \begin{equation*}
    e\vdash s\trans{utxos}{t}s'
  \end{equation*}
  then
  \begin{equation*}
    \Val(s) + \varphi(wm, t) = \Val(s')
  \end{equation*}
  where
  \begin{equation*}
    wm = \fun{coinToValue} (\fun{wbalance}~(\fun{txwdrl}~t)) + \fun{mint}~(\fun{txbody}~t)
  \end{equation*}
\end{lemma}
\begin{proof}
  In the case that $\fun{txValTag}~t = \True$ holds, the proof is
  identical to the proof of Lemma 9.1 of the multi-asset
  specification. Otherwise, the transition must have been done via the
  $\mathsf{Scripts-No}$ rule, which removes
  $\fun{txinputs_{fee}}~(\fun{txbody}~t)$ from the UTxO and adds their
  total value to the fees and changes nothing else, thus not changing the value contained in $s$.
\end{proof}

\begin{lemma}
  For all environments $e$, transactions $t$ and states $s, s'$, if
  \begin{equation*}
    e\vdash s\trans{ledger}{t}s'
  \end{equation*}
  then
  \begin{equation*}
    \Val(s) + \varphi(\fun{mint}~(\fun{txbody}~t), t) = \Val(s')
  \end{equation*}
\end{lemma}
\begin{proof}
  If $\fun{txValTag}~t = \True$, the transition is via the
  $\mathsf{ledger-V}$ rule, and the claim follows from the previous lemma
  and Lemma 15.7 of the Shelley specification. Otherwise, it follows
  directly from the previous lemma.
\end{proof}

We now turn to properties of the ledger that relate to what
transactions can and cannot do depending of whether their scripts
validate or not.

\begin{lemma}
  For all environments $e$, transactions $t$ and states $s, s'$, if $\fun{txvaltag}~t = \False$ and
  \begin{equation*}
    e\vdash s\trans{ledger}{t}s'
  \end{equation*}
  then $\Utxo(s') = \fun{txinputs_{fee}}~{txb} \subtractdom \Utxo(s)$.
\end{lemma}
\begin{proof}
  As the $\mathsf{LEDGER}$, $\mathsf{UTXOW}$ and $\mathsf{UTXO}$ transitions
  only modify their UTxO state via $\mathsf{UTXOS}$ transitions, it
  suffices to show the equivalent claim for $\mathsf{UTXOS}$
  transitions. This follows immediately from $\fun{txValTag}~t = \False$.
\end{proof}

\begin{corollary}
  For all environments $e$, transactions $t$ and states $s, s'$, if
  $\Utxo(s') \not\subset \Utxo(s)$ and
  \begin{equation*}
    e\vdash s\trans{ledger}{t}s'
  \end{equation*}
  then $\fun{txValTag}~t = \True$.
\end{corollary}
\begin{proof}
  This follows immediately from the previous lemma.
\end{proof}

\begin{lemma}
  For all environments $e$, transactions $t$ and states $s, s'$ such that
  \begin{equation*}
    e\vdash s\trans{ledger}{t}s',
  \end{equation*}
  If $\range (\fun{txscripts}~t) \cap \ScriptNonNative = \emptyset$
  then $\fun{txValTag} = \True$.
\end{lemma}
\begin{proof}
  With the same argument as previously, we only need to discuss the
  equivalent claim for the $\mathsf{UTXOS}$ transition. Under these
  assumptions, $\var{sLst} := \fun{collectNNScriptInputs}$ is an empty
  list. Thus $\fun{evalScripts}~sLst = \True$, and the transition rule
  had to be $\mathsf{Scripts{-}Yes}$.
\end{proof}